<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>待办事项记录板</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --accent-color: #4895ef;
            --danger-color: #f72585;
            --success-color: #4cc9f0;
            --warning-color: #f8961e;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --gray-color: #6c757d;
            --border-radius: 12px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Noto Sans SC', sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: var(--dark-color);
            line-height: 1.6;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            position: relative;
            padding-bottom: 80px;
        }
        
        h1, h2, h3 {
            color: var(--primary-color);
            font-weight: 700;
            margin-bottom: 1rem;
        }
        
        h1 {
            text-align: center;
            font-size: 2rem;
            margin: 1rem 0 2rem;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid rgba(67, 97, 238, 0.2);
        }
        
        .nav {
            display: flex;
            justify-content: space-around;
            background-color: white;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 12px 0;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }
        
        .nav button {
            background: none;
            border: none;
            color: var(--gray-color);
            font-size: 0.9rem;
            padding: 8px 16px;
            cursor: pointer;
            border-radius: 20px;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .nav button i {
            font-size: 1.2rem;
            margin-bottom: 4px;
        }
        
        .nav button.active {
            background-color: rgba(67, 97, 238, 0.1);
            color: var(--primary-color);
            font-weight: 500;
        }
        
        .page {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .page.active {
            display: block;
        }
        
        .card {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }
        
        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        
        .card h3 {
            font-size: 1.1rem;
            margin-bottom: 8px;
            color: var(--dark-color);
        }
        
        .card p {
            color: var(--gray-color);
            font-size: 0.9rem;
            margin-bottom: 6px;
        }
        
        .task-meta {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 0.8rem;
            color: var(--gray-color);
        }
        
        .btn {
            border: none;
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn i {
            margin-right: 6px;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--secondary-color);
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #3aa8d8;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #e5177b;
        }
        
        .priority-tag {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
            margin-right: 8px;
        }
        
        .priority-1 {
            background-color: rgba(247, 37, 133, 0.1);
            color: var(--danger-color);
            border-left: 3px solid var(--danger-color);
        }
        
        .priority-2 {
            background-color: rgba(248, 150, 30, 0.1);
            color: var(--warning-color);
            border-left: 3px solid var(--warning-color);
        }
        
        .priority-3 {
            background-color: rgba(72, 149, 239, 0.1);
            color: var(--accent-color);
            border-left: 3px solid var(--accent-color);
        }
        
        .priority-4 {
            background-color: rgba(76, 201, 240, 0.1);
            color: var(--success-color);
            border-left: 3px solid var(--success-color);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark-color);
        }
        
        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #e0e0e0;
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }
        
        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }
        
        .radio-group, .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }
        
        .radio-option, .checkbox-option {
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        
        .radio-option input, .checkbox-option input {
            margin-right: 8px;
            cursor: pointer;
        }
        
        .no-tasks {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray-color);
        }
        
        .no-tasks i {
            font-size: 2rem;
            margin-bottom: 16px;
            color: #dee2e6;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }
        
        .stat-card {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            box-shadow: var(--box-shadow);
        }
        
        .stat-card .stat-title {
            font-size: 0.9rem;
            color: var(--gray-color);
            margin-bottom: 8px;
        }
        
        .stat-card .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .date-filters {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .date-filters select {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid #e0e0e0;
            border-radius: var(--border-radius);
            font-size: 0.9rem;
        }
        
        .priority-section {
            margin-bottom: 24px;
        }
        
        .priority-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--dark-color);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            align-items: center;
        }
        
        .priority-title::before {
            content: "";
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .priority-1-title::before {
            background-color: var(--danger-color);
        }
        
        .priority-2-title::before {
            background-color: var(--warning-color);
        }
        
        .priority-3-title::before {
            background-color: var(--accent-color);
        }
        
        .priority-4-title::before {
            background-color: var(--success-color);
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
                padding-bottom: 80px;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            .stats-container {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div class="container">
        <h1><i class="fas fa-tasks"></i> 待办事项记录板</h1>
        
        <!-- 待办页面 -->
        <div id="todo-page" class="page active">
            <h2><i class="fas fa-calendar-day"></i> 今日待办事项</h2>
            
            <div id="today-tasks">
                <!-- 今日任务将在这里动态生成 -->
            </div>
            
            <h2><i class="fas fa-list-ol"></i> 任务分类</h2>
            
            <div class="priority-section">
                <div class="priority-title priority-1-title">紧急且重要</div>
                <div id="priority-1-tasks" class="priority-tasks">
                    <!-- 紧急且重要任务将在这里动态生成 -->
                </div>
            </div>
            
            <div class="priority-section">
                <div class="priority-title priority-2-title">重要但不紧急</div>
                <div id="priority-2-tasks" class="priority-tasks">
                    <!-- 重要但不紧急任务将在这里动态生成 -->
                </div>
            </div>
            
            <div class="priority-section">
                <div class="priority-title priority-3-title">紧急但不重要</div>
                <div id="priority-3-tasks" class="priority-tasks">
                    <!-- 紧急但不重要任务将在这里动态生成 -->
                </div>
            </div>
            
            <div class="priority-section">
                <div class="priority-title priority-4-title">不紧急且不重要</div>
                <div id="priority-4-tasks" class="priority-tasks">
                    <!-- 不紧急且不重要任务将在这里动态生成 -->
                </div>
            </div>
        </div>
        
        <!-- 添加页面 -->
        <div id="add-page" class="page">
            <h2><i class="fas fa-plus-circle"></i> 添加新任务</h2>
            
            <form id="add-task-form">
                <div class="form-group">
                    <label for="task-name"><i class="fas fa-heading"></i> 项目名称</label>
                    <input type="text" id="task-name" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="task-notes"><i class="fas fa-sticky-note"></i> 项目备注</label>
                    <textarea id="task-notes" class="form-control"></textarea>
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-calendar-alt"></i> 任务类型</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="task-type" value="once" checked> 一次性任务
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="task-type" value="recurring"> 持续性任务
                        </label>
                    </div>
                </div>
                
                <div class="form-group" id="recurring-days-container" style="display: none;">
                    <label><i class="fas fa-redo"></i> 选择重复日期</label>
                    <div class="checkbox-group">
                        <label class="checkbox-option">
                            <input type="checkbox" name="recurring-day" value="1"> 周一
                        </label>
                        <label class="checkbox-option">
                            <input type="checkbox" name="recurring-day" value="2"> 周二
                        </label>
                        <label class="checkbox-option">
                            <input type="checkbox" name="recurring-day" value="3"> 周三
                        </label>
                        <label class="checkbox-option">
                            <input type="checkbox" name="recurring-day" value="4"> 周四
                        </label>
                        <label class="checkbox-option">
                            <input type="checkbox" name="recurring-day" value="5"> 周五
                        </label>
                        <label class="checkbox-option">
                            <input type="checkbox" name="recurring-day" value="6"> 周六
                        </label>
                        <label class="checkbox-option">
                            <input type="checkbox" name="recurring-day" value="0"> 周日
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="task-start-date"><i class="fas fa-calendar-plus"></i> 开始日期</label>
                    <input type="date" id="task-start-date" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="task-end-date"><i class="fas fa-calendar-minus"></i> 结束日期 (可选)</label>
                    <input type="date" id="task-end-date" class="form-control">
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-exclamation-circle"></i> 优先级</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="priority" value="1" required> 紧急且重要
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="priority" value="2"> 重要但不紧急
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="priority" value="3"> 紧急但不重要
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="priority" value="4"> 不紧急且不重要
                        </label>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary"><i class="fas fa-check"></i> 创建任务</button>
            </form>
        </div>
        
        <!-- 历史页面 -->
        <div id="history-page" class="page">
            <h2><i class="fas fa-history"></i> 历史记录</h2>
            
            <div class="date-filters">
                <select id="history-month" class="form-control">
                    <option value="">所有月份</option>
                    <option value="1">一月</option>
                    <option value="2">二月</option>
                    <option value="3">三月</option>
                    <option value="4">四月</option>
                    <option value="5">五月</option>
                    <option value="6">六月</option>
                    <option value="7">七月</option>
                    <option value="8">八月</option>
                    <option value="9">九月</option>
                    <option value="10">十月</option>
                    <option value="11">十一月</option>
                    <option value="12">十二月</option>
                </select>
                
                <select id="history-year" class="form-control">
                    <option value="">所有年份</option>
                    <!-- 年份将通过JavaScript动态生成 -->
                </select>
            </div>
            
            <div id="history-tasks">
                <!-- 历史任务将在这里动态生成 -->
            </div>
        </div>
        
        <!-- 统计页面 -->
        <div id="stats-page" class="page">
            <h2><i class="fas fa-chart-pie"></i> 任务统计</h2>
            
            <div class="date-filters">
                <select id="stats-period" class="form-control">
                    <option value="week">本周</option>
                    <option value="month">本月</option>
                    <option value="year">本年</option>
                    <option value="all">全部</option>
                </select>
            </div>
            
            <h3><i class="fas fa-chart-bar"></i> 完成情况</h3>
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-title">总任务数</div>
                    <div class="stat-value" id="total-tasks">0</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-title">已完成</div>
                    <div class="stat-value" id="completed-tasks">0</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-title">完成率</div>
                    <div class="stat-value" id="completion-rate">0%</div>
                </div>
            </div>
            
            <h3><i class="fas fa-layer-group"></i> 优先级分布</h3>
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-title">紧急且重要</div>
                    <div class="stat-value" id="priority-1-count">0</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-title">重要但不紧急</div>
                    <div class="stat-value" id="priority-2-count">0</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-title">紧急但不重要</div>
                    <div class="stat-value" id="priority-3-count">0</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-title">不紧急且不重要</div>
                    <div class="stat-value" id="priority-4-count">0</div>
                </div>
            </div>
        </div>
        
        <!-- 导航栏 -->
        <div class="nav">
            <button id="todo-btn" class="active">
                <i class="fas fa-tasks"></i>
                <span>待办</span>
            </button>
            <button id="add-btn">
                <i class="fas fa-plus"></i>
                <span>添加</span>
            </button>
            <button id="history-btn">
                <i class="fas fa-history"></i>
                <span>历史</span>
            </button>
            <button id="stats-btn">
                <i class="fas fa-chart-pie"></i>
                <span>统计</span>
            </button>
        </div>
    </div>

    <script>
        // 页面切换逻辑
        document.getElementById('todo-btn').addEventListener('click', function() {
            switchPage('todo');
        });
        
        document.getElementById('add-btn').addEventListener('click', function() {
            switchPage('add');
        });
        
        document.getElementById('history-btn').addEventListener('click', function() {
            switchPage('history');
            loadHistoryTasks();
        });
        
        document.getElementById('stats-btn').addEventListener('click', function() {
            switchPage('stats');
            updateStats();
        });
        
        function switchPage(page) {
            // 隐藏所有页面
            document.querySelectorAll('.page').forEach(p => {
                p.classList.remove('active');
            });
            
            // 移除所有导航按钮的active类
            document.querySelectorAll('.nav button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // 显示选中的页面
            document.getElementById(page + '-page').classList.add('active');
            document.getElementById(page + '-btn').classList.add('active');
        }
        
        // 任务类型切换显示重复日期选项
        document.querySelectorAll('input[name="task-type"]').forEach(radio => {
            radio.addEventListener('change', function() {
                document.getElementById('recurring-days-container').style.display = 
                    this.value === 'recurring' ? 'block' : 'none';
            });
        });
        
        // 初始化日期输入
        document.getElementById('task-start-date').valueAsDate = new Date();
        
        // 任务管理
        let tasks = JSON.parse(localStorage.getItem('tasks')) || [];
        let completedTasks = JSON.parse(localStorage.getItem('completedTasks')) || [];
        
        // 添加任务表单提交
        document.getElementById('add-task-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const name = document.getElementById('task-name').value;
            const notes = document.getElementById('task-notes').value;
            const taskType = document.querySelector('input[name="task-type"]:checked').value;
            const startDate = document.getElementById('task-start-date').value;
            const endDate = document.getElementById('task-end-date').value || null;
            const priority = document.querySelector('input[name="priority"]:checked').value;
            
            let recurringDays = [];
            if (taskType === 'recurring') {
                document.querySelectorAll('input[name="recurring-day"]:checked').forEach(day => {
                    recurringDays.push(parseInt(day.value));
                });
                
                if (recurringDays.length === 0) {
                    alert('请至少选择一个重复日期');
                    return;
                }
            }
            
            const newTask = {
                id: Date.now(),
                name,
                notes,
                type: taskType,
                startDate,
                endDate,
                priority: parseInt(priority),
                recurringDays,
                completed: false,
                createdAt: new Date().toISOString()
            };
            
            tasks.push(newTask);
            saveTasks();
            
            // 重置表单
            this.reset();
            document.getElementById('task-start-date').valueAsDate = new Date();
            document.getElementById('recurring-days-container').style.display = 'none';
            
            // 显示成功消息
            alert('任务添加成功！');
            
            // 刷新待办列表
            loadTodayTasks();
            
            // 返回待办页面
            switchPage('todo');
        });
        
        // 保存任务到本地存储
        function saveTasks() {
            localStorage.setItem('tasks', JSON.stringify(tasks));
            localStorage.setItem('completedTasks', JSON.stringify(completedTasks));
        }
        
        // 加载今日任务
        function loadTodayTasks() {
            const today = new Date();
            const todayStr = formatDate(today);
            const dayOfWeek = today.getDay(); // 0是周日，6是周六
            
            const todayTasksContainer = document.getElementById('today-tasks');
            todayTasksContainer.innerHTML = '';
            
            const priorityContainers = {
                1: document.getElementById('priority-1-tasks'),
                2: document.getElementById('priority-2-tasks'),
                3: document.getElementById('priority-3-tasks'),
                4: document.getElementById('priority-4-tasks')
            };
            
            // 清空优先级容器
            Object.values(priorityContainers).forEach(container => {
                container.innerHTML = '';
            });
            
            // 筛选今天的任务
            const todayTasks = tasks.filter(task => {
                // 检查任务是否在有效期内
                if (task.endDate && new Date(task.endDate) < today) {
                    return false;
                }
                
                if (new Date(task.startDate) > today) {
                    return false;
                }
                
                // 一次性任务
                if (task.type === 'once') {
                    return formatDate(new Date(task.startDate)) === todayStr && !task.completed;
                }
                
                // 持续性任务
                if (task.type === 'recurring') {
                    // 检查今天是否是选中的重复日
                    return task.recurringDays.includes(dayOfWeek) && !task.completed;
                }
                
                return false;
            });
            
            if (todayTasks.length === 0) {
                todayTasksContainer.innerHTML = `
                    <div class="no-tasks">
                        <i class="fas fa-check-circle"></i>
                        <p>今日没有待办事项</p>
                    </div>
                `;
            } else {
                todayTasks.forEach(task => {
                    const taskElement = createTaskElement(task, true);
                    todayTasksContainer.appendChild(taskElement);
                });
            }
            
            // 按优先级分类显示所有未完成任务
            const uncompletedTasks = tasks.filter(task => !task.completed);
            
            if (uncompletedTasks.length === 0) {
                Object.values(priorityContainers).forEach(container => {
                    container.innerHTML = `
                        <div class="no-tasks">
                            <i class="fas fa-check-circle"></i>
                            <p>暂无任务</p>
                        </div>
                    `;
                });
            } else {
                uncompletedTasks.forEach(task => {
                    const priority = task.priority;
                    const taskElement = createTaskElement(task, false);
                    priorityContainers[priority].appendChild(taskElement);
                });
            }
        }
        
        // 创建任务元素
        function createTaskElement(task, showCompleteButton) {
            const taskElement = document.createElement('div');
            taskElement.className = `card priority-${task.priority}`;
            taskElement.dataset.id = task.id;
            
            let html = `
                <h3>${task.name}</h3>
                ${task.notes ? `<p>${task.notes}</p>` : ''}
                <div class="task-meta">
                    <span><i class="fas fa-layer-group"></i> ${getPriorityName(task.priority)}</span>
                    <span><i class="fas fa-calendar-day"></i> ${formatDisplayDate(task.startDate)}</span>
                </div>
            `;
            
            if (task.endDate) {
                html = html.replace('</div>', `<span><i class="fas fa-calendar-times"></i> ${formatDisplayDate(task.endDate)}</span></div>`);
            }
            
            if (task.type === 'recurring') {
                const days = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'];
                const recurringDaysStr = task.recurringDays.map(day => days[day]).join(', ');
                html = html.replace('</div>', `<span><i class="fas fa-redo"></i> ${recurringDaysStr}</span></div>`);
            }
            
            if (showCompleteButton) {
                html += `<button class="btn btn-success complete-btn" data-id="${task.id}"><i class="fas fa-check"></i> 完成</button>`;
            }
            
            taskElement.innerHTML = html;
            
            if (showCompleteButton) {
                taskElement.querySelector('.complete-btn').addEventListener('click', function() {
                    completeTask(task.id);
                });
            }
            
            return taskElement;
        }
        
        // 完成任务
        function completeTask(taskId) {
            const taskIndex = tasks.findIndex(task => task.id === taskId);
            
            if (taskIndex !== -1) {
                const task = tasks[taskIndex];
                const completedTask = {
                    ...task,
                    completed: true,
                    completedAt: new Date().toISOString()
                };
                
                // 如果是持续性任务，不标记为已完成，而是记录完成历史
                if (task.type === 'recurring') {
                    completedTasks.push(completedTask);
                } else {
                    // 一次性任务，标记为已完成并从任务列表中移除
                    tasks.splice(taskIndex, 1);
                    completedTasks.push(completedTask);
                }
                
                saveTasks();
                loadTodayTasks();
                
                // 显示完成动画
                const taskElement = document.querySelector(`.card[data-id="${taskId}"]`);
                if (taskElement) {
                    taskElement.style.transform = 'scale(0.95)';
                    taskElement.style.opacity = '0.5';
                    setTimeout(() => {
                        taskElement.style.transition = 'all 0.3s ease';
                        taskElement.style.height = '0';
                        taskElement.style.margin = '0';
                        taskElement.style.padding = '0';
                        taskElement.style.overflow = 'hidden';
                        setTimeout(() => {
                            taskElement.remove();
                        }, 300);
                    }, 200);
                }
            }
        }
        
        // 加载历史任务
        function loadHistoryTasks() {
            const historyContainer = document.getElementById('history-tasks');
            historyContainer.innerHTML = '';
            
            const monthFilter = document.getElementById('history-month').value;
            const yearFilter = document.getElementById('history-year').value;
            
            let filteredTasks = [...completedTasks];
            
            if (monthFilter || yearFilter) {
                filteredTasks = filteredTasks.filter(task => {
                    const date = new Date(task.completedAt || task.createdAt);
                    const taskMonth = date.getMonth() + 1;
                    const taskYear = date.getFullYear();
                    
                    return (
                        (!monthFilter || taskMonth.toString() === monthFilter) &&
                        (!yearFilter || taskYear.toString() === yearFilter)
                    );
                });
            }
            
            if (filteredTasks.length === 0) {
                historyContainer.innerHTML = `
                    <div class="no-tasks">
                        <i class="fas fa-history"></i>
                        <p>没有历史记录</p>
                    </div>
                `;
                return;
            }
            
            // 按日期排序
            filteredTasks.sort((a, b) => {
                const dateA = new Date(a.completedAt || a.createdAt);
                const dateB = new Date(b.completedAt || b.createdAt);
                return dateB - dateA;
            });
            
            // 按日期分组
            const tasksByDate = {};
            filteredTasks.forEach(task => {
                const date = new Date(task.completedAt || task.createdAt);
                const dateStr = formatDisplayDate(date);
                
                if (!tasksByDate[dateStr]) {
                    tasksByDate[dateStr] = [];
                }
                
                tasksByDate[dateStr].push(task);
            });
            
            // 显示分组后的任务
            for (const [date, dateTasks] of Object.entries(tasksByDate)) {
                const dateHeader = document.createElement('h3');
                dateHeader.textContent = date;
                dateHeader.style.marginTop = '20px';
                dateHeader.style.color = 'var(--gray-color)';
                historyContainer.appendChild(dateHeader);
                
                dateTasks.forEach(task => {
                    const taskElement = document.createElement('div');
                    taskElement.className = `card priority-${task.priority}`;
                    
                    let html = `
                        <h3>${task.name}</h3>
                        ${task.notes ? `<p>${task.notes}</p>` : ''}
                        <div class="task-meta">
                            <span><i class="fas fa-layer-group"></i> ${getPriorityName(task.priority)}</span>
                            <span><i class="fas fa-clock"></i> ${formatDisplayDateTime(new Date(task.completedAt || task.createdAt))}</span>
                        </div>
                        <button class="btn btn-danger delete-btn" data-id="${task.id}"><i class="fas fa-trash"></i> 删除</button>
                    `;
                    
                    taskElement.innerHTML = html;
                    historyContainer.appendChild(taskElement);
                    
                    // 添加删除按钮事件
                    taskElement.querySelector('.delete-btn').addEventListener('click', function() {
                        deleteHistoryTask(task.id);
                    });
                });
            }
        }
        
        // 删除历史任务
        function deleteHistoryTask(taskId) {
            if (confirm('确定要删除此任务记录吗？')) {
                const index = completedTasks.findIndex(task => task.id === taskId);
                if (index !== -1) {
                    completedTasks.splice(index, 1);
                    saveTasks();
                    
                    // 显示删除动画
                    const taskElement = document.querySelector(`.card[data-id="${taskId}"]`);
                    if (taskElement) {
                        taskElement.style.transform = 'scale(0.95)';
                        taskElement.style.opacity = '0';
                        setTimeout(() => {
                            taskElement.remove();
                            loadHistoryTasks(); // 重新加载历史任务
                        }, 300);
                    }
                }
            }
        }
        
        // 更新统计信息
        function updateStats() {
            const period = document.getElementById('stats-period').value;
            const now = new Date();
            let startDate, endDate;
            
            switch (period) {
                case 'week':
                    // 本周开始（周一）
                    const dayOfWeek = now.getDay() || 7; // 0是周日，转换为7
                    startDate = new Date(now);
                    startDate.setDate(now.getDate() - dayOfWeek + 1);
                    startDate.setHours(0, 0, 0, 0);
                    endDate = new Date(now);
                    endDate.setHours(23, 59, 59, 999);
                    break;
                case 'month':
                    // 本月开始
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
                    break;
                case 'year':
                    // 本年开始
                    startDate = new Date(now.getFullYear(), 0, 1);
                    endDate = new Date(now.getFullYear(), 11, 31, 23, 59, 59, 999);
                    break;
                default: // all
                    startDate = new Date(0);
                    endDate = new Date();
                    break;
            }
            
            // 筛选任务
            const filteredTasks = completedTasks.filter(task => {
                const taskDate = new Date(task.completedAt || task.createdAt);
                return taskDate >= startDate && taskDate <= endDate;
            });
            
            const totalTasks = filteredTasks.length;
            
            // 按优先级统计
            const priorityCounts = [0, 0, 0, 0];
            filteredTasks.forEach(task => {
                priorityCounts[task.priority - 1]++;
            });
            
            // 更新UI
            document.getElementById('total-tasks').textContent = totalTasks;
            document.getElementById('completed-tasks').textContent = totalTasks;
            document.getElementById('completion-rate').textContent = '100%';
            
            document.getElementById('priority-1-count').textContent = priorityCounts[0];
            document.getElementById('priority-2-count').textContent = priorityCounts[1];
            document.getElementById('priority-3-count').textContent = priorityCounts[2];
            document.getElementById('priority-4-count').textContent = priorityCounts[3];
        }
        
        // 辅助函数
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        function formatDisplayDate(dateStr) {
            const date = new Date(dateStr);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}年${month}月${day}日`;
        }
        
        function formatDisplayDateTime(date) {
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${formatDisplayDate(date)} ${hours}:${minutes}`;
        }
        
        function getPriorityName(priority) {
            const names = {
                1: '紧急且重要',
                2: '重要但不紧急',
                3: '紧急但不重要',
                4: '不紧急且不重要'
            };
            return names[priority] || '未知';
        }
        
        // 初始化年份选择器
        function initYearSelector() {
            const yearSelect = document.getElementById('history-year');
            const currentYear = new Date().getFullYear();
            
            for (let year = currentYear; year >= currentYear - 10; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            }
        }
        
        // 初始化事件监听器
        document.getElementById('history-month').addEventListener('change', loadHistoryTasks);
        document.getElementById('history-year').addEventListener('change', loadHistoryTasks);
        document.getElementById('stats-period').addEventListener('change', updateStats);
        
        // 初始化应用
        initYearSelector();
        loadTodayTasks();
    </script>
</body>
</html>
