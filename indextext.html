<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <title>推理题</title>
    <style>
        /* 平滑滚动效果 */
        html {
            scroll-behavior: smooth;
        }

        /* 悬停动画效果 */
        .hover-scale:hover {
            transform: scale(1.05);
            transition: transform 0.3s ease;
        }

        /* 答对和答错结果样式 */
        .correct-answer {
            color: green;
            font-weight: bold;
        }

        .wrong-answer {
            color: red;
            font-weight: bold;
        }

        /* 结果弹窗样式 */
        .result-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .result-modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
            width: 80%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        /* 五彩商标样式 */
        .rainbow-text {
            background-image: linear-gradient(to right, red, orange, yellow, green, blue);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-size: 2rem;
            font-weight: bold;
        }

        /* 密码输入弹窗样式 */
        .password-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .password-modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
            width: 80%;
            max-width: 300px;
        }

        /* 登录注册模态框样式 */
        .auth-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .auth-modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
            width: 80%;
            max-width: 400px;
        }

        /* 计时器样式 */
        .timer {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 5px;
            display: inline-block;
            margin-bottom: 10px;
        }

        .timer-warning {
            color: orange;
        }

        .timer-danger {
            color: red;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* 排行榜样式 */
        .leaderboard {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .leaderboard th, .leaderboard td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .leaderboard th {
            background-color: #f2f2f2;
        }

        .leaderboard tr:hover {
            background-color: #f5f5f5;
        }

        /* 讨论区消息样式 */
        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 5px;
            background-color: #f9f9f9;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .message-content {
            word-wrap: break-word;
        }

        /* 个人资料编辑样式 */
        .profile-edit input, .profile-edit textarea {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>

<body class="bg-gray-100 font-sans">
    <!-- 导航栏 -->
    <nav class="bg-white shadow-md p-4 flex justify-between items-center">
        <h1 class="rainbow-text">推理题</h1>
        <div class="flex items-center">
            <input type="text" id="search-input" placeholder="搜索往期题目" class="border border-gray-300 rounded p-2">
            <button id="search-button" class="bg-blue-500 text-white p-2 rounded ml-2" onclick="searchPeriods()">搜索</button>
            <div id="user-info" class="ml-4 hidden">
                <span id="username-display" class="mr-2"></span>
                <button onclick="showProfileModal()" class="bg-green-500 text-white p-2 rounded">个人中心</button>
                <button onclick="logout()" class="bg-red-500 text-white p-2 rounded ml-2">退出</button>
            </div>
            <div id="auth-buttons" class="ml-4">
                <button onclick="showLoginModal()" class="bg-blue-500 text-white p-2 rounded">登录</button>
                <button onclick="showRegisterModal()" class="bg-green-500 text-white p-2 rounded ml-2">注册</button>
            </div>
        </div>
    </nav>

    <!-- 首页内容 -->
    <div id="home" class="p-8">
        <!-- 用户信息展示 -->
        <div id="user-profile" class="bg-white p-6 rounded shadow-md mb-8 hidden">
            <div class="flex justify-between items-center">
                <div>
                    <h2 id="profile-username" class="text-2xl font-bold"></h2>
                    <p id="profile-signature" class="text-gray-600"></p>
                    <p class="text-blue-500 font-bold mt-2">积分: <span id="profile-points">0</span></p>
                </div>
                <button onclick="showProfileModal()" class="bg-blue-500 text-white p-2 rounded">编辑资料</button>
            </div>
        </div>

        <!-- 积分排行榜 -->
        <div id="leaderboard" class="bg-white p-6 rounded shadow-md mb-8 hidden">
            <h2 class="text-2xl font-bold mb-4">积分排行榜</h2>
            <div class="overflow-x-auto">
                <table class="leaderboard">
                    <thead>
                        <tr>
                            <th>排名</th>
                            <th>用户名</th>
                            <th>积分</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboard-body">
                        <!-- 排行榜内容将通过 JavaScript 动态添加 -->
                    </tbody>
                </table>
            </div>
            <p class="mt-2">你的当前排名: <span id="user-rank" class="font-bold">-</span></p>
        </div>

        <!-- 最新3期显示 -->
        <div id="latest-periods" class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- 期内容将通过 JavaScript 动态添加 -->
        </div>

        <!-- 玩法介绍、关于声明、联系我们 -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-8">
            <div class="bg-white p-6 rounded shadow-md hover-scale cursor-pointer" onclick="showPlayMethod()">
                <h3 class="text-lg font-bold">玩法介绍</h3>
            </div>
            <div class="bg-white p-6 rounded shadow-md hover-scale cursor-pointer" onclick="showAbout()">
                <h3 class="text-lg font-bold">关于和声明</h3>
            </div>
            <div class="bg-white p-6 rounded shadow-md hover-scale cursor-pointer" onclick="showForumPage()">
                <h3 class="text-lg font-bold">讨论区</h3>
            </div>
        </div>

        <!-- 显示所有期按钮 -->
        <button class="bg-blue-500 text-white p-6 rounded mt-8 hover-scale cursor-pointer" onclick="showAllPeriods()">显示所有期</button>
    </div>

    <!-- 详细页内容 -->
    <div id="detail" class="p-8 hidden">
        <!-- 计时器 -->
        <div id="timer-container" class="mb-4 hidden">
            <div class="timer" id="timer">剩余时间: 00:00</div>
            <button id="restart-timer" class="bg-blue-500 text-white p-2 rounded ml-2 hidden" onclick="restartTimer()">重新开始</button>
        </div>
        
        <!-- 题目显示 -->
        <div id="question-container" class="bg-white p-6 rounded shadow-md mb-8">
            <!-- 题目将通过 JavaScript 动态添加 -->
        </div>
        <!-- 提交答案按钮 -->
        <button id="submit-answers" class="bg-green-500 text-white p-2 rounded" onclick="checkAnswers()">提交答案</button>
        <!-- 结果显示 -->
        <div id="result" class="mt-4 hidden">
            <!-- 结果将通过 JavaScript 动态添加 -->
        </div>
        <!-- 返回首页按钮 -->
        <button class="bg-gray-300 text-white p-2 rounded mt-4" onclick="goHome()">返回首页</button>
    </div>

    <!-- 所有期列表 -->
    <div id="all-periods" class="p-8 hidden">
        <!-- 期列表将通过 JavaScript 动态添加 -->
        <div class="flex justify-between mt-4">
            <button class="bg-gray-300 p-2 rounded" onclick="prevPage()">上一页</button>
            <button class="bg-gray-300 p-2 rounded" onclick="nextPage()">下一页</button>
        </div>
        <!-- 返回首页按钮 -->
        <button class="bg-gray-300 text-white p-2 rounded mt-4" onclick="goHome()">返回首页</button>
    </div>

    <!-- 讨论区页面 -->
    <div id="forum-page" class="p-8 hidden">
        <h2 class="text-2xl font-bold mb-4">讨论区</h2>
        
        <!-- 发消息表单 -->
        <div class="bg-white p-6 rounded shadow-md mb-8">
            <h3 class="text-lg font-bold mb-2">发表新消息</h3>
            <textarea id="new-message" class="border border-gray-300 rounded p-2 w-full h-24 mb-2" placeholder="输入你的消息..."></textarea>
            <button onclick="postMessage()" class="bg-blue-500 text-white p-2 rounded">发布</button>
        </div>
        
        <!-- 消息列表 -->
        <div id="message-list" class="bg-white p-6 rounded shadow-md">
            <h3 class="text-lg font-bold mb-4">最新消息</h3>
            <div id="messages-container">
                <!-- 消息将通过 JavaScript 动态添加 -->
            </div>
        </div>
        
        <!-- 返回首页按钮 -->
        <button class="bg-gray-300 text-white p-2 rounded mt-4" onclick="goHome()">返回首页</button>
    </div>

    <!-- 个人主页 -->
    <div id="profile-page" class="p-8 hidden">
        <div class="bg-white p-6 rounded shadow-md mb-8">
            <h2 id="view-profile-username" class="text-2xl font-bold mb-2"></h2>
            <p id="view-profile-signature" class="text-gray-600 mb-4"></p>
            <p class="text-blue-500 font-bold">积分: <span id="view-profile-points">0</span></p>
        </div>
        
        <div class="bg-white p-6 rounded shadow-md">
            <h3 class="text-lg font-bold mb-4">答题成就</h3>
            <div id="achievements-container">
                <!-- 成就将通过 JavaScript 动态添加 -->
            </div>
        </div>
        
        <!-- 返回首页按钮 -->
        <button class="bg-gray-300 text-white p-2 rounded mt-4" onclick="goHome()">返回首页</button>
    </div>

    <!-- 玩法介绍模态框 -->
    <div id="play-method-modal" class="fixed top-0 left-0 w-full h-full bg-black bg-opacity-50 hidden justify-center items-center">
        <div class="bg-white p-8 rounded shadow-md">
            <h2 class="text-2xl font-bold mb-4">玩法介绍</h2>
            <p>感谢使用推理题，每一期都有我们精心准备的题目，您选择完答案后点击提交，会自动生成报告。部分题目是为个别人准备的，所以需要提取码才能观看，请谅解～祝您玩的愉快！</p>
            <button class="bg-gray-300 p-2 rounded mt-4" onclick="closePlayMethod()">关闭</button>
        </div>
    </div>

    <!-- 关于和声明模态框 -->
    <div id="about-modal" class="fixed top-0 left-0 w-full h-full bg-black bg-opacity-50 hidden justify-center items-center">
        <div class="bg-white p-8 rounded shadow-md">
            <h2 class="text-2xl font-bold mb-4">关于和声明</h2>
            <p>本网站的推理题仅供娱乐，无其他不良引导，如有巧合，纯属雷同。</p>
            <button class="bg-gray-300 p-2 rounded mt-4" onclick="closeAbout()">关闭</button>
        </div>
    </div>

    <!-- 结果弹窗 -->
    <div id="result-modal" class="result-modal">
        <div class="result-modal-content">
            <h2 id="result-modal-title" class="text-2xl font-bold mb-4"></h2>
            <div id="result-modal-body"></div>
            <button class="bg-gray-300 p-2 rounded mt-4" onclick="closeResultModal()">关闭</button>
        </div>
    </div>

    <!-- 密码输入弹窗 -->
    <div id="password-modal" class="password-modal">
        <div class="password-modal-content">
            <h2 class="text-lg font-bold mb-2">请输入六位提取码</h2>
            <input type="text" id="password-input" class="border border-gray-300 rounded p-2 mb-2" maxlength="6">
            <button class="bg-blue-500 text-white p-2 rounded" onclick="checkPassword()">提交</button>
            <button class="bg-gray-300 p-2 rounded ml-2" onclick="closePasswordModal()">取消</button>
        </div>
    </div>

    <!-- 登录模态框 -->
    <div id="login-modal" class="auth-modal">
        <div class="auth-modal-content">
            <h2 class="text-2xl font-bold mb-4">登录</h2>
            <div id="login-error" class="text-red-500 mb-2 hidden"></div>
            <input type="email" id="login-email" placeholder="邮箱" class="border border-gray-300 rounded p-2 mb-2 w-full">
            <input type="password" id="login-password" placeholder="密码" class="border border-gray-300 rounded p-2 mb-4 w-full">
            <button onclick="login()" class="bg-blue-500 text-white p-2 rounded w-full">登录</button>
            <button class="bg-gray-300 p-2 rounded mt-2 w-full" onclick="closeLoginModal()">取消</button>
        </div>
    </div>

    <!-- 注册模态框 -->
    <div id="register-modal" class="auth-modal">
        <div class="auth-modal-content">
            <h2 class="text-2xl font-bold mb-4">注册</h2>
            <div id="register-error" class="text-red-500 mb-2 hidden"></div>
            <input type="text" id="register-username" placeholder="用户名" class="border border-gray-300 rounded p-2 mb-2 w-full">
            <input type="email" id="register-email" placeholder="邮箱" class="border border-gray-300 rounded p-2 mb-2 w-full">
            <input type="password" id="register-password" placeholder="密码" class="border border-gray-300 rounded p-2 mb-2 w-full">
            <input type="password" id="register-confirm-password" placeholder="确认密码" class="border border-gray-300 rounded p-2 mb-4 w-full">
            <button onclick="register()" class="bg-blue-500 text-white p-2 rounded w-full">注册</button>
            <button class="bg-gray-300 p-2 rounded mt-2 w-full" onclick="closeRegisterModal()">取消</button>
        </div>
    </div>

    <!-- 个人资料编辑模态框 -->
    <div id="profile-modal" class="auth-modal">
        <div class="auth-modal-content">
            <h2 class="text-2xl font-bold mb-4">编辑个人资料</h2>
            <div id="profile-error" class="text-red-500 mb-2 hidden"></div>
            <div class="profile-edit">
                <input type="text" id="edit-username" placeholder="用户名" class="border border-gray-300 rounded p-2 mb-2 w-full">
                <textarea id="edit-signature" placeholder="个性签名" class="border border-gray-300 rounded p-2 mb-2 w-full h-24"></textarea>
                <button onclick="updateProfile()" class="bg-blue-500 text-white p-2 rounded w-full">保存</button>
                <button class="bg-gray-300 p-2 rounded mt-2 w-full" onclick="closeProfileModal()">取消</button>
            </div>
        </div>
    </div>

    <script>
        // Firebase 配置 - 你需要替换为你自己的配置
        const firebaseConfig = {
          apiKey: "AIzaSyBSoEWyffAmwAf_QACrSMzmA3o3Ekja5VE",
          authDomain: "my-chat-66148.firebaseapp.com",
          databaseURL: "https://my-chat-66148-default-rtdb.firebaseio.com",
          projectId: "my-chat-66148",
          storageBucket: "my-chat-66148.firebasestorage.app",
          messagingSenderId: "545613708614",
          appId: "1:545613708614:web:8023b0540945278d853947",
          measurementId: "G-Q64BH5T3XT"
        };
        // 初始化 Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // 模拟数据库数据，增加了解析字段和密码相关字段（按期）
        const questionsDatabase = {
            "1": {
                "title": "第1期-测试网站",
                "description": "这是第4期推理题的简介，快来挑战吧！",
                "questions": [
                    {
                        "type": "choice",
                        "question": "---",
                        "options": ["-", "--", "---"],
                        "answer": "-",
                        "explanation": "-----",
                        "points": 5  // 答对获得的积分
                    }
                ],
                "needPassword": false,
                "timeLimit": 300  // 时间限制，单位秒
            },
            "2": {
                "title": "第2期-网站测试",
                "description": "第2期---测试",
                "questions": [
                    {
                        "type": "choice",
                        "question": "测试题目-",
                        "options": ["选我", "选隔壁"],
                        "answer": "选我",
                        "explanation": "————本题没有解析",
                        "points": 10
                    }
                ],
                "needPassword": false,
                "timeLimit": 180
            },
            "3": {
                "title": "第3期",
                "description": "这是一个私人对话，需要输入验证码～",
                "questions": [
                    {
                        "type": "choice",
                        "question": "HI：23，很高兴遇到你。你觉得我的网站怎么样？很不错吧！   （因为我为了能使用github pages，选择了Public，也就是公开的，所以我只能讲这么多。）下期再见！ 问题：你会记得我吗（以后）",
                        "options": ["会", "不会", "不确定"],
                        "answer": "会",
                        "explanation": "-本题没有解析-",
                        "points": 15
                    }
                ],
                "needPassword": true,
                "password": "232323",
                "timeLimit": 240
            },
            "4": {
                "title": "第4期",
                "description": "简单推理题目-快来挑战",
                "questions": [
                    {
                        "type": "choice",
                        "question": "富翁陈先生在别墅遇害，现场有半杯未喝完的咖啡，法医鉴定死亡时间为下午 3 点，咖啡中含剧毒。当天拜访过的人有：A（秘书）：1 点送文件后离开，曾为陈先生冲咖啡。B（客户）：2 点半会谈，中途去洗手间 5 分钟。C（园丁）：下午修剪草坪，3 点后在花园浇水。问题：谁最可能是凶手？",
                        "options": ["秘书", "客户", "园丁"],
                        "answer": "秘书",
                        "explanation": "咖啡未喝完且含毒，说明毒是在陈先生喝咖啡前放入的。秘书 1 点冲咖啡，若当时下毒，陈先生不会等到 3 点才毒发。但秘书可能在离开前将毒放入咖啡壶，陈先生后续饮用时中毒。客户中途离开时间短，园丁 3 点后在花园，无机会接触咖啡。",
                        "points": 20
                    },
                    {
                        "type": "choice",
                        "question": "话剧演员张小姐在后台被杀，手中紧握一张撕成两半的扑克牌「方块 J」。嫌疑人有：A（导演）：曾因剧本争吵，方块 J 是导演英文名 "Jack" 的缩写。B（对手演员）：饰演皇后，与张小姐有竞争关系。C（化妆师）：案发时在为其他演员补妆。问题：凶手是谁？",
                        "options": ["导演", "对手演员", "化妆师"],
                        "answer": "对手演员",
                        "explanation": "方块 J 中的 J 是 "Jack"，但撕成两半暗示 "皇后"（Queen），因皇后的扑克牌是 Q，对应对手演员的角色。",
                        "points": 20
                    }
                ],
                "needPassword": false,
                "timeLimit": 600
            },
            "5": {
                "title": "第5期",
                "description": "谁是凶手-第五期。简单版---",
                "questions": [
                    {
                        "type": "choice",
                        "question": "富豪在自家的密室书房中被杀，密室门窗从内反锁，无任何撬痕。书房内，富豪倒在书桌旁，手中紧握一支钢笔，笔尖被折断。书桌上有一张白纸，上面有一些凌乱的划痕。嫌疑人有三个：A 是富豪的私人秘书，因长期被克扣工资心怀不满；B 是富豪的商业竞争对手，近期生意上吃了大亏；C 是富豪的侄子，觊觎富豪的遗产。谁是凶手？",
                        "options": ["A", "B", "C"],
                        "answer": "A",
                        "explanation": "密室反锁且无撬痕，说明凶手是能从内部离开或有特殊方法离开的人。富豪手中紧握折断笔尖的钢笔和白纸上的划痕，暗示在遇害前试图留下线索。秘书日常接触富豪，熟知其生活习惯和书房环境，有机会在离开时反锁门窗。钢笔和划痕可能是富豪在试图写下凶手名字时，被秘书发现并破坏。相比之下，商业竞争对手和侄子进入密室且不破坏门锁的难度较大，且没有直接证据指向他们与钢笔、划痕的关联 。",
                        "points": 25
                    },
                    {
                        "type": "choice",
                        "question": "一位知名画家被发现死在自己的密室画室中，画室的门从里面用密码锁锁住，密码锁只有画家自己知道。画家倒在画架前，画布上是一幅未完成的肖像画，画的是一个女人的侧脸。死者手中握着调色刀，刀上有蓝色颜料。嫌疑人有：A 是画家的模特，曾因报酬问题与画家争吵；B 是画家的徒弟，嫉妒画家的才华；C 是画家的前妻，离婚后财产分割不均。谁是凶手？",
                        "options": ["A", "B", "C"],
                        "answer": "A",
                        "explanation": "密码锁只有画家自己知道，凶手能进入密室，很可能是画家主动让其进入。画布上是未完成的女人侧脸肖像画，结合调色刀上的蓝色颜料，推测画家在作画过程中遇害。模特作为经常为画家当模特的人，画家会为其开门。因报酬问题产生矛盾，有杀人动机，而徒弟和前妻没有与作画场景直接相关的联系，从作案条件和动机上看，模特嫌疑最大。",
                        "points": 25
                    }
                ],
                "needPassword": false,
                "timeLimit": 480
            },
            "6": {
                "title": "第--期 网站测试",
                "description": "网站测试",
                "questions": [
                    {
                        "type": "choice",
                        "question": "富豪在自家的密室书房中被杀，密室门窗从内反锁，无任何撬痕。书房内，富豪倒在书桌旁，手中紧握一支钢笔，笔尖被折断。书桌上有一张白纸，上面有一些凌乱的划痕。嫌疑人有三个：A 是富豪的私人秘书，因长期被克扣工资心怀不满；B 是富豪的商业竞争对手，近期生意上吃了大亏；C 是富豪的侄子，觊觎富豪的遗产。谁是凶手？",
                        "options": ["A", "B", "C"],
                        "answer": "A",
                        "explanation": "密室反锁且无撬痕，说明凶手是能从内部离开或有特殊方法离开的人。富豪手中紧握折断笔尖的钢笔和白纸上的划痕，暗示在遇害前试图留下线索。秘书日常接触富豪，熟知其生活习惯和书房环境，有机会在离开时反锁门窗。钢笔和划痕可能是富豪在试图写下凶手名字时，被秘书发现并破坏。相比之下，商业竞争对手和侄子进入密室且不破坏门锁的难度较大，且没有直接证据指向他们与钢笔、划痕的关联 。",
                        "points": 30
                    },
                    {
                        "type": "choice",
                        "question": "一位知名画家被发现死在自己的密室画室中，画室的门从里面用密码锁锁住，密码锁只有画家自己知道。画家倒在画架前，画布上是一幅未完成的肖像画，画的是一个女人的侧脸。死者手中握着调色刀，刀上有蓝色颜料。嫌疑人有：A 是画家的模特，曾因报酬问题与画家争吵；B 是画家的徒弟，嫉妒画家的才华；C 是画家的前妻，离婚后财产分割不均。谁是凶手？",
                        "options": ["A", "B", "C"],
                        "answer": "A",
                        "explanation": "密码锁只有画家自己知道，凶手能进入密室，很可能是画家主动让其进入。画布上是未完成的女人侧脸肖像画，结合调色刀上的蓝色颜料，推测画家在作画过程中遇害。模特作为经常为画家当模特的人，画家会为其开门。因报酬问题产生矛盾，有杀人动机，而徒弟和前妻没有与作画场景直接相关的联系，从作案条件和动机上看，模特嫌疑最大。",
                        "points": 30
                    },
                    {
                        "type": "fill",
                        "question": "请填写出 1 + 1 的结果",
                        "answer": "2",
                        "explanation": "根据基本数学运算，1 + 1 的结果为 2。",
                        "points": 10
                    }
                ],
                "needPassword": true,
                "password": "112323",
                "timeLimit": 720
            }
        };

        // 按期数降序排序
        const periods = Object.keys(questionsDatabase).sort((a, b) => b - a);
        let currentPage = 1;
        const itemsPerPage = 5;
        let currentPeriodId;
        let timer;
        let timeLeft;
        let currentUser = null;
        let userProfile = null;

        // 初始化页面
        window.onload = function() {
            initAuth();
            initHome();
        };

        // 初始化认证状态监听
        function initAuth() {
            auth.onAuthStateChanged((user) => {
                if (user) {
                    currentUser = user;
                    loadUserProfile();
                    document.getElementById('user-info').classList.remove('hidden');
                    document.getElementById('auth-buttons').classList.add('hidden');
                    document.getElementById('user-profile').classList.remove('hidden');
                    document.getElementById('leaderboard').classList.remove('hidden');
                    document.getElementById('username-display').textContent = user.displayName || user.email;
                } else {
                    currentUser = null;
                    userProfile = null;
                    document.getElementById('user-info').classList.add('hidden');
                    document.getElementById('auth-buttons').classList.remove('hidden');
                    document.getElementById('user-profile').classList.add('hidden');
                    document.getElementById('leaderboard').classList.add('hidden');
                }
            });
        }

        // 加载用户资料
        function loadUserProfile() {
            if (!currentUser) return;
            
            database.ref('users/' + currentUser.uid).once('value').then((snapshot) => {
                userProfile = snapshot.val() || {
                    username: currentUser.displayName || currentUser.email.split('@')[0],
                    email: currentUser.email,
                    points: 0,
                    signature: '这个人很懒，什么也没留下~',
                    achievements: {}
                };
                
                // 更新页面显示
                document.getElementById('profile-username').textContent = userProfile.username;
                document.getElementById('profile-signature').textContent = userProfile.signature;
                document.getElementById('profile-points').textContent = userProfile.points;
                document.getElementById('username-display').textContent = userProfile.username;
                
                // 加载排行榜
                loadLeaderboard();
            });
        }

        // 加载排行榜
        function loadLeaderboard() {
            database.ref('users').orderByChild('points').limitToLast(5).once('value').then((snapshot) => {
                const users = [];
                snapshot.forEach((childSnapshot) => {
                    users.push({
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    });
                });
                
                // 按积分降序排序
                users.sort((a, b) => b.points - a.points);
                
                // 更新排行榜
                const leaderboardBody = document.getElementById('leaderboard-body');
                leaderboardBody.innerHTML = '';
                
                users.forEach((user, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${user.username}</td>
                        <td>${user.points}</td>
                        <td><button onclick="viewUserProfile('${user.id}')" class="bg-blue-500 text-white p-1 rounded text-sm">查看</button></td>
                    `;
                    leaderboardBody.appendChild(row);
                });
                
                // 查找当前用户排名
                if (currentUser && userProfile) {
                    database.ref('users').orderByChild('points').once('value').then((allSnapshot) => {
                        const allUsers = [];
                        allSnapshot.forEach((childSnapshot) => {
                            allUsers.push({
                                id: childSnapshot.key,
                                ...childSnapshot.val()
                            });
                        });
                        
                        // 按积分降序排序
                        allUsers.sort((a, b) => b.points - a.points);
                        
                        // 查找当前用户排名
                        const userIndex = allUsers.findIndex(u => u.id === currentUser.uid);
                        if (userIndex !== -1) {
                            document.getElementById('user-rank').textContent = userIndex + 1;
                        }
                    });
                }
            });
        }

        // 查看用户主页
        function viewUserProfile(userId) {
            database.ref('users/' + userId).once('value').then((snapshot) => {
                const profile = snapshot.val();
                if (profile) {
                    document.getElementById('view-profile-username').textContent = profile.username;
                    document.getElementById('view-profile-signature').textContent = profile.signature;
                    document.getElementById('view-profile-points').textContent = profile.points;
                    
                    // 显示成就
                    const achievementsContainer = document.getElementById('achievements-container');
                    achievementsContainer.innerHTML = '<p>加载中...</p>';
                    
                    // 获取所有期数
                    const allPeriods = Object.keys(questionsDatabase);
                    let completedCount = 0;
                    
                    // 检查用户完成了哪些期
                    const achievementsList = document.createElement('div');
                    allPeriods.forEach(period => {
                        if (profile.achievements && profile.achievements[period]) {
                            completedCount++;
                            const periodDiv = document.createElement('div');
                            periodDiv.classList.add('mb-2');
                            periodDiv.innerHTML = `
                                <p class="font-bold">${questionsDatabase[period].title}</p>
                                <p>得分: ${profile.achievements[period].score} (用时: ${formatTime(profile.achievements[period].timeUsed)})</p>
                            `;
                            achievementsList.appendChild(periodDiv);
                        }
                    });
                    
                    if (completedCount === 0) {
                        achievementsContainer.innerHTML = '<p>该用户还没有完成任何题目</p>';
                    } else {
                        achievementsContainer.innerHTML = `<p>已完成 ${completedCount} 期题目</p>`;
                        achievementsContainer.appendChild(achievementsList);
                    }
                    
                    // 显示用户主页
                    document.getElementById('home').classList.add('hidden');
                    document.getElementById('detail').classList.add('hidden');
                    document.getElementById('all-periods').classList.add('hidden');
                    document.getElementById('forum-page').classList.add('hidden');
                    document.getElementById('profile-page').classList.remove('hidden');
                }
            });
        }

        // 显示玩法介绍
        function showPlayMethod() {
            document.getElementById('play-method-modal').classList.remove('hidden');
        }

        // 关闭玩法介绍
        function closePlayMethod() {
            document.getElementById('play-method-modal').classList.add('hidden');
        }

        // 显示关于和声明
        function showAbout() {
            document.getElementById('about-modal').classList.remove('hidden');
        }

        // 关闭关于和声明
        function closeAbout() {
            document.getElementById('about-modal').classList.add('hidden');
        }

        // 显示所有期
        function showAllPeriods() {
            document.getElementById('home').classList.add('hidden');
            document.getElementById('detail').classList.add('hidden');
            document.getElementById('all-periods').classList.remove('hidden');

            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const currentPeriods = periods.slice(startIndex, endIndex);

            const periodList = document.createElement('div');
            currentPeriods.forEach(period => {
                const periodDiv = document.createElement('div');
                periodDiv.classList.add('bg-white', 'p-6', 'rounded', 'shadow-md', 'mb-4', 'hover-scale', 'cursor-pointer');
                if (questionsDatabase[period].needPassword) {
                    periodDiv.innerHTML = `<p>${questionsDatabase[period].title} - 需要提取码才能查看</p>`;
                    const unlockButton = document.createElement('button');
                    unlockButton.classList.add('bg-blue-500', 'text-white', 'p-2', 'rounded');
                    unlockButton.textContent = '输入提取码';
                    unlockButton.onclick = () => {
                        currentPeriodId = period;
                        showPasswordModal();
                    };
                    periodDiv.appendChild(unlockButton);
                } else {
                    periodDiv.textContent = questionsDatabase[period].title;
                    periodDiv.onclick = () => showDetail(period);
                }
                periodList.appendChild(periodDiv);
            });

            const allPeriodsContainer = document.getElementById('all-periods');
            allPeriodsContainer.innerHTML = '';
            allPeriodsContainer.appendChild(periodList);

            const pagination = document.createElement('div');
            pagination.classList.add('flex', 'justify-between', 'mt-4');
            const prevButton = document.createElement('button');
            prevButton.classList.add('bg-gray-300', 'p-2', 'rounded');
            prevButton.textContent = '上一页';
            prevButton.onclick = prevPage;
            const nextButton = document.createElement('button');
            nextButton.classList.add('bg-gray-300', 'p-2', 'rounded');
            nextButton.textContent = '下一页';
            nextButton.onclick = nextPage;
            pagination.appendChild(prevButton);
            pagination.appendChild(nextButton);
            allPeriodsContainer.appendChild(pagination);
        }

        // 上一页
        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                showAllPeriods();
            }
        }

        // 下一页
        function nextPage() {
            const totalPages = Math.ceil(periods.length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                showAllPeriods();
            }
        }

        // 显示详细页
        function showDetail(period) {
            if (!currentUser) {
                alert('请先登录后再答题');
                showLoginModal();
                return;
            }
            
            currentPeriodId = period;
            if (questionsDatabase[period].needPassword) {
                showPasswordModal();
            } else {
                document.getElementById('home').classList.add('hidden');
                document.getElementById('all-periods').classList.add('hidden');
                document.getElementById('detail').classList.remove('hidden');

                const questionContainer = document.getElementById('question-container');
                questionContainer.innerHTML = `<h2 class="text-2xl font-bold mb-4">${questionsDatabase[period].title}</h2>`;

                questionsDatabase[period].questions.forEach((question, index) => {
                    const questionDiv = document.createElement('div');
                    questionDiv.classList.add('mb-4');
                    questionDiv.innerHTML = `<p class="text-lg font-bold">${index + 1}. ${question.question}</p>`;

                    if (question.type === 'fill') {
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.id = `question-${index}`;
                        input.style.border = '1px solid #ccc';
                        input.style.padding = '5px';
                        input.style.marginTop = '5px';
                        input.style.width = '100%';
                        questionDiv.appendChild(input);
                    } else if (question.type === 'choice') {
                        question.options.forEach(option => {
                            const label = document.createElement('label');
                            label.classList.add('block', 'mb-1');
                            const radio = document.createElement('input');
                            radio.type = 'radio';
                            radio.name = `question-${index}`;
                            radio.value = option;
                            label.appendChild(radio);
                            label.appendChild(document.createTextNode(option));
                            questionDiv.appendChild(label);
                        });
                    }

                    questionContainer.appendChild(questionDiv);
                });

                // 设置计时器
                setupTimer(questionsDatabase[period].timeLimit);
            }
        }

        // 设置计时器
        function setupTimer(seconds) {
            clearInterval(timer);
            
            const timerContainer = document.getElementById('timer-container');
            const timerElement = document.getElementById('timer');
            const restartButton = document.getElementById('restart-timer');
            
            timerContainer.classList.remove('hidden');
            restartButton.classList.add('hidden');
            
            timeLeft = seconds;
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    timerElement.textContent = "时间到！";
                    timerElement.classList.add('timer-danger');
                    document.getElementById('submit-answers').click();
                } else if (timeLeft <= 30) {
                    timerElement.classList.remove('timer-warning');
                    timerElement.classList.add('timer-danger');
                } else if (timeLeft <= 60) {
                    timerElement.classList.add('timer-warning');
                }
            }, 1000);
        }

        // 更新计时器显示
        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            document.getElementById('timer').textContent = `剩余时间: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // 重新开始计时器
        function restartTimer() {
            if (currentPeriodId && questionsDatabase[currentPeriodId]) {
                setupTimer(questionsDatabase[currentPeriodId].timeLimit);
            }
        }

        // 检查答案
        function checkAnswers() {
            clearInterval(timer);
            document.getElementById('restart-timer').classList.remove('hidden');
            
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '';
            resultDiv.classList.remove('hidden');

            const currentPeriod = questionsDatabase[currentPeriodId];
            const correctAnswers = [];
            const wrongAnswers = [];
            let totalScore = 0;
            const startTime = new Date().getTime();

            currentPeriod.questions.forEach((question, index) => {
                let userAnswer;
                if (question.type === 'fill') {
                    userAnswer = document.getElementById(`question-${index}`).value;
                } else if (question.type === 'choice') {
                    const radios = document.querySelectorAll(`input[name="question-${index}"]`);
                    radios.forEach(radio => {
                        if (radio.checked) {
                            userAnswer = radio.value;
                        }
                    });
                }

                const isCorrect = userAnswer === question.answer;
                const resultText = isCorrect ? '答对了' : '答错了';
                const resultP = document.createElement('p');
                resultP.textContent = `${index + 1}. ${resultText}`;
                if (isCorrect) {
                    resultP.classList.add('correct-answer');
                    correctAnswers.push({ question: question.question, index: index + 1 });
                    totalScore += question.points;
                } else {
                    resultP.classList.add('wrong-answer');
                    wrongAnswers.push({ question: question.question, index: index + 1, explanation: question.explanation });
                }
                resultDiv.appendChild(resultP);
            });

            // 计算用时
            const endTime = new Date().getTime();
            const timeUsed = Math.floor((endTime - startTime) / 1000); // 秒
            
            // 更新用户积分和成就
            if (currentUser && userProfile) {
                const newPoints = userProfile.points + totalScore;
                const newAchievements = {
                    ...userProfile.achievements,
                    [currentPeriodId]: {
                        score: totalScore,
                        timeUsed: timeUsed,
                        completedAt: new Date().toISOString()
                    }
                };
                
                database.ref('users/' + currentUser.uid).update({
                    points: newPoints,
                    achievements: newAchievements
                }).then(() => {
                    userProfile.points = newPoints;
                    userProfile.achievements = newAchievements;
                    document.getElementById('profile-points').textContent = newPoints;
                    loadLeaderboard();
                });
            }
            
            showResultModal(correctAnswers, wrongAnswers, totalScore, timeUsed);
        }

        // 显示结果弹窗
        function showResultModal(correctAnswers, wrongAnswers, totalScore, timeUsed) {
            const resultModal = document.getElementById('result-modal');
            const resultModalTitle = document.getElementById('result-modal-title');
            const resultModalBody = document.getElementById('result-modal-body');

            resultModalBody.innerHTML = '';

            // 显示总分和用时
            const scoreInfo = document.createElement('div');
            scoreInfo.classList.add('mb-4');
            scoreInfo.innerHTML = `
                <p class="text-xl font-bold">总分: ${totalScore}</p>
                <p>用时: ${formatTime(timeUsed)}</p>
            `;
            resultModalBody.appendChild(scoreInfo);

            if (correctAnswers.length > 0) {
                const correctSection = document.createElement('div');
                correctSection.innerHTML = '<p class="font-bold text-green-500">答对的题目:</p>';
                correctAnswers.forEach(item => {
                    const p = document.createElement('p');
                    p.textContent = `${item.index}. ${item.question} - 答对啦，你真棒！`;
                    p.classList.add('correct-answer');
                    correctSection.appendChild(p);
                });
                resultModalBody.appendChild(correctSection);
            }

            if (wrongAnswers.length > 0) {
                if (correctAnswers.length > 0) {
                    const separator = document.createElement('hr');
                    resultModalBody.appendChild(separator);
                }
                const wrongSection = document.createElement('div');
                wrongSection.innerHTML = '<p class="font-bold text-red-500">答错的题目:</p>';
                wrongAnswers.forEach(item => {
                    const p = document.createElement('p');
                    p.textContent = `${item.index}. ${item.question} - 答错了，解析：${item.explanation}`;
                    p.classList.add('wrong-answer');
                    wrongSection.appendChild(p);
                });
                resultModalBody.appendChild(wrongSection);
            }

            resultModal.style.display = 'flex';
        }

        // 格式化时间显示
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // 关闭结果弹窗
        function closeResultModal() {
            const resultModal = document.getElementById('result-modal');
            resultModal.style.display = 'none';
        }

        // 搜索期
        function searchPeriods() {
            const searchInput = document.getElementById('search-input').value.toLowerCase();
            const filteredPeriods = periods.filter(period => {
                const title = questionsDatabase[period].title.toLowerCase();
                const description = questionsDatabase[period].description.toLowerCase();
                const hasMatchInQuestions = questionsDatabase[period].questions.some(q => {
                    const questionText = q.question.toLowerCase();
                    return questionText.includes(searchInput);
                });
                return title.includes(searchInput) || description.includes(searchInput) || hasMatchInQuestions;
            });

            document.getElementById('home').classList.add('hidden');
            document.getElementById('detail').classList.add('hidden');
            document.getElementById('all-periods').classList.remove('hidden');

            const periodList = document.createElement('div');
            filteredPeriods.forEach(period => {
                const periodDiv = document.createElement('div');
                periodDiv.classList.add('bg-white', 'p-6', 'rounded', 'shadow-md', 'mb-4', 'hover-scale', 'cursor-pointer');
                if (questionsDatabase[period].needPassword) {
                    periodDiv.innerHTML = `<p>${questionsDatabase[period].title} - 需要提取码才能查看</p>`;
                    const unlockButton = document.createElement('button');
                    unlockButton.classList.add('bg-blue-500', 'text-white', 'p-2', 'rounded');
                    unlockButton.textContent = '输入提取码';
                    unlockButton.onclick = () => {
                        currentPeriodId = period;
                        showPasswordModal();
                    };
                    periodDiv.appendChild(unlockButton);
                } else {
                    periodDiv.textContent = questionsDatabase[period].title;
                    periodDiv.onclick = () => showDetail(period);
                }
                periodList.appendChild(periodDiv);
            });

            const allPeriodsContainer = document.getElementById('all-periods');
            allPeriodsContainer.innerHTML = '';
            allPeriodsContainer.appendChild(periodList);

            const pagination = document.createElement('div');
            pagination.classList.add('flex', 'justify-between', 'mt-4');
            const prevButton = document.createElement('button');
            prevButton.classList.add('bg-gray-300', 'p-2', 'rounded');
            prevButton.textContent = '上一页';
            prevButton.onclick = prevPage;
            const nextButton = document.createElement('button');
            nextButton.classList.add('bg-gray-300', 'p-2', 'rounded');
            nextButton.textContent = '下一页';
            nextButton.onclick = nextPage;
            pagination.appendChild(prevButton);
            pagination.appendChild(nextButton);
            allPeriodsContainer.appendChild(pagination);
        }

        // 显示密码输入弹窗
        function showPasswordModal() {
            document.getElementById('password-modal').style.display = 'flex';
        }

        // 关闭密码输入弹窗
        function closePasswordModal() {
            document.getElementById('password-modal').style.display = 'none';
            document.getElementById('password-input').value = '';
        }

        // 检查密码
        function checkPassword() {
            const passwordInput = document.getElementById('password-input').value;
            const currentPeriod = questionsDatabase[currentPeriodId];

            if (passwordInput === currentPeriod.password) {
                closePasswordModal();
                document.getElementById('home').classList.add('hidden');
                document.getElementById('all-periods').classList.add('hidden');
                document.getElementById('detail').classList.remove('hidden');

                const questionContainer = document.getElementById('question-container');
                questionContainer.innerHTML = `<h2 class="text-2xl font-bold mb-4">${currentPeriod.title}</h2>`;

                currentPeriod.questions.forEach((question, index) => {
                    const questionDiv = document.createElement('div');
                    questionDiv.classList.add('mb-4');
                    questionDiv.innerHTML = `<p class="text-lg font-bold">${index + 1}. ${question.question}</p>`;

                    if (question.type === 'fill') {
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.id = `question-${index}`;
                        input.style.border = '1px solid #ccc';
                        input.style.padding = '5px';
                        input.style.marginTop = '5px';
                        input.style.width = '100%';
                        questionDiv.appendChild(input);
                    } else if (question.type === 'choice') {
                        question.options.forEach(option => {
                            const label = document.createElement('label');
                            label.classList.add('block', 'mb-1');
                            const radio = document.createElement('input');
                            radio.type = 'radio';
                            radio.name = `question-${index}`;
                            radio.value = option;
                            label.appendChild(radio);
                            label.appendChild(document.createTextNode(option));
                            questionDiv.appendChild(label);
                        });
                    }

                    questionContainer.appendChild(questionDiv);
                });

                // 设置计时器
                setupTimer(currentPeriod.timeLimit);
            } else {
                alert('输入错误，请重新输入提取码！');
                document.getElementById('password-input').value = '';
            }
        }

        // 返回首页
        function goHome() {
            document.getElementById('home').classList.remove('hidden');
            document.getElementById('detail').classList.add('hidden');
            document.getElementById('all-periods').classList.add('hidden');
            document.getElementById('forum-page').classList.add('hidden');
            document.getElementById('profile-page').classList.add('hidden');
        }

        // 显示讨论区页面
        function showForumPage() {
            if (!currentUser) {
                alert('请先登录后再访问讨论区');
                showLoginModal();
                return;
            }
            
            document.getElementById('home').classList.add('hidden');
            document.getElementById('detail').classList.add('hidden');
            document.getElementById('all-periods').classList.add('hidden');
            document.getElementById('profile-page').classList.add('hidden');
            document.getElementById('forum-page').classList.remove('hidden');
            
            loadMessages();
        }

        // 加载讨论区消息
        function loadMessages() {
            database.ref('messages').orderByChild('timestamp').limitToLast(20).once('value').then((snapshot) => {
                const messagesContainer = document.getElementById('messages-container');
                messagesContainer.innerHTML = '';
                
                const messages = [];
                snapshot.forEach((childSnapshot) => {
                    messages.push({
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    });
                });
                
                // 按时间倒序排列
                messages.reverse();
                
                messages.forEach(message => {
                    const messageDiv = document.createElement('div');
                    messageDiv.classList.add('message');
                    messageDiv.innerHTML = `
                        <div class="message-header">
                            <span>${message.username}</span>
                            <span>${new Date(message.timestamp).toLocaleString()}</span>
                        </div>
                        <div class="message-content">${message.content}</div>
                    `;
                    messagesContainer.appendChild(messageDiv);
                });
            });
        }

        // 发布消息
        function postMessage() {
            if (!currentUser || !userProfile) {
                alert('请先登录后再发布消息');
                return;
            }
            
            const messageContent = document.getElementById('new-message').value.trim();
            if (!messageContent) {
                alert('请输入消息内容');
                return;
            }
            
            const newMessage = {
                userId: currentUser.uid,
                username: userProfile.username,
                content: messageContent,
                timestamp: new Date().getTime()
            };
            
            database.ref('messages').push(newMessage).then(() => {
                document.getElementById('new-message').value = '';
                loadMessages();
            });
        }

        // 显示登录模态框
        function showLoginModal() {
            document.getElementById('login-error').classList.add('hidden');
            document.getElementById('login-email').value = '';
            document.getElementById('login-password').value = '';
            document.getElementById('login-modal').classList.remove('hidden');
        }

        // 关闭登录模态框
        function closeLoginModal() {
            document.getElementById('login-modal').classList.add('hidden');
        }

        // 显示注册模态框
        function showRegisterModal() {
            document.getElementById('register-error').classList.add('hidden');
            document.getElementById('register-username').value = '';
            document.getElementById('register-email').value = '';
            document.getElementById('register-password').value = '';
            document.getElementById('register-confirm-password').value = '';
            document.getElementById('register-modal').classList.remove('hidden');
        }

        // 关闭注册模态框
        function closeRegisterModal() {
            document.getElementById('register-modal').classList.add('hidden');
        }

        // 显示个人资料编辑模态框
        function showProfileModal() {
            if (!currentUser || !userProfile) return;
            
            document.getElementById('profile-error').classList.add('hidden');
            document.getElementById('edit-username').value = userProfile.username;
            document.getElementById('edit-signature').value = userProfile.signature;
            document.getElementById('profile-modal').classList.remove('hidden');
        }

        // 关闭个人资料编辑模态框
        function closeProfileModal() {
            document.getElementById('profile-modal').classList.add('hidden');
        }

        // 登录
        function login() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorElement = document.getElementById('login-error');
            
            if (!email || !password) {
                errorElement.textContent = '请输入邮箱和密码';
                errorElement.classList.remove('hidden');
                return;
            }
            
            auth.signInWithEmailAndPassword(email, password)
                .then(() => {
                    closeLoginModal();
                })
                .catch((error) => {
                    errorElement.textContent = getAuthErrorMessage(error.code);
                    errorElement.classList.remove('hidden');
                });
        }

        // 注册
        function register() {
            const username = document.getElementById('register-username').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-confirm-password').value;
            const errorElement = document.getElementById('register-error');
            
            if (!username || !email || !password || !confirmPassword) {
                errorElement.textContent = '请填写所有字段';
                errorElement.classList.remove('hidden');
                return;
            }
            
            if (password !== confirmPassword) {
                errorElement.textContent = '两次输入的密码不一致';
                errorElement.classList.remove('hidden');
                return;
            }
            
            if (password.length < 6) {
                errorElement.textContent = '密码长度至少为6位';
                errorElement.classList.remove('hidden');
                return;
            }
            
            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // 更新用户显示名称
                    return userCredential.user.updateProfile({
                        displayName: username
                    }).then(() => {
                        // 保存用户资料到数据库
                        return database.ref('users/' + userCredential.user.uid).set({
                            username: username,
                            email: email,
                            points: 0,
                            signature: '这个人很懒，什么也没留下~',
                            achievements: {}
                        });
                    });
                })
                .then(() => {
                    closeRegisterModal();
                })
                .catch((error) => {
                    errorElement.textContent = getAuthErrorMessage(error.code);
                    errorElement.classList.remove('hidden');
                });
        }

        // 更新个人资料
        function updateProfile() {
            if (!currentUser) return;
            
            const newUsername = document.getElementById('edit-username').value;
            const newSignature = document.getElementById('edit-signature').value;
            const errorElement = document.getElementById('profile-error');
            
            if (!newUsername) {
                errorElement.textContent = '请输入用户名';
                errorElement.classList.remove('hidden');
                return;
            }
            
            // 更新用户资料
            database.ref('users/' + currentUser.uid).update({
                username: newUsername,
                signature: newSignature
            }).then(() => {
                // 更新用户显示名称
                currentUser.updateProfile({
                    displayName: newUsername
                }).then(() => {
                    userProfile.username = newUsername;
                    userProfile.signature = newSignature;
                    
                    // 更新页面显示
                    document.getElementById('profile-username').textContent = newUsername;
                    document.getElementById('profile-signature').textContent = newSignature;
                    document.getElementById('username-display').textContent = newUsername;
                    
                    closeProfileModal();
                });
            }).catch((error) => {
                errorElement.textContent = '更新失败，请重试';
                errorElement.classList.remove('hidden');
            });
        }

        // 退出登录
        function logout() {
            auth.signOut().then(() => {
                goHome();
            });
        }

        // 获取认证错误消息
        function getAuthErrorMessage(errorCode) {
            switch (errorCode) {
                case 'auth/email-already-in-use':
                    return '该邮箱已被注册';
                case 'auth/invalid-email':
                    return '无效的邮箱地址';
                case 'auth/operation-not-allowed':
                    return '操作不被允许';
                case 'auth/weak-password':
                    return '密码太弱';
                case 'auth/user-disabled':
                    return '用户已被禁用';
                case 'auth/user-not-found':
                    return '用户不存在';
                case 'auth/wrong-password':
                    return '密码错误';
                default:
                    return '发生错误，请重试';
            }
        }

        // 初始化首页
        function initHome() {
            const latestPeriods = periods.slice(0, 3);
            const latestPeriodsContainer = document.getElementById('latest-periods');
            latestPeriodsContainer.innerHTML = '';
            
            latestPeriods.forEach(period => {
                const periodDiv = document.createElement('div');
                periodDiv.classList.add('bg-white', 'p-6', 'rounded', 'shadow-md', 'hover-scale', 'cursor-pointer');
                if (questionsDatabase[period].needPassword) {
                    periodDiv.innerHTML = `<h2 class="text-2xl font-bold mb-2">最新！new ${questionsDatabase[period].title} - 需要提取码</h2><p class="text-gray-600">${questionsDatabase[period].description}</p>`;
                    const unlockButton = document.createElement('button');
                    unlockButton.classList.add('bg-blue-500', 'text-white', 'p-2', 'rounded', 'mt-2');
                    unlockButton.textContent = '输入提取码';
                    unlockButton.onclick = () => {
                        currentPeriodId = period;
                        showPasswordModal();
                    };
                    periodDiv.appendChild(unlockButton);
                } else {
                    periodDiv.innerHTML = `<h2 class="text-2xl font-bold mb-2">最新！new ${questionsDatabase[period].title}</h2><p class="text-gray-600">${questionsDatabase[period].description}</p>`;
                    periodDiv.onclick = () => showDetail(period);
                }
                latestPeriodsContainer.appendChild(periodDiv);
            });
        }
    </script>
</body>

</html>
